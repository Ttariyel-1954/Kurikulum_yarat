# =============================================================================
# CURRICULUM GENERATOR MODULE - COMPLETE & CLEAN
# =============================================================================

# UI
curriculum_generator_ui <- function(id) {
  ns <- NS(id)
  
  tagList(
    # Header
    div(
      style = "background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
               color: white; padding: 40px; border-radius: 15px; 
               margin-bottom: 30px; text-align: center;",
      h2(icon("magic"), " AI Kurikulum Generator", style = "margin: 0; font-size: 2.5em;"),
      p("S√ºni intellekt il…ô professional t…ôhsil kurikulum yaradƒ±n", 
        style = "font-size: 1.2em; margin-top: 15px;")
    ),
    
    # Main Form
    fluidRow(
      box(
        title = tagList(icon("edit"), " Parametrl…ôr"),
        status = "primary",
        solidHeader = TRUE,
        width = 8,
        
        fluidRow(
          column(6,
                 selectInput(ns("subject"),
                             label = tagList(icon("book"), " F…ônn *"),
                             choices = setNames(SUBJECTS$name_az, SUBJECTS$name_az),
                             width = "100%")
          ),
          column(6,
                 selectInput(ns("grade"),
                             label = tagList(icon("graduation-cap"), " Sinif *"),
                             choices = setNames(GRADES$grade, GRADES$level_az),
                             width = "100%")
          )
        ),
        
        fluidRow(
          column(4,
                 numericInput(ns("hours_per_week"),
                              label = tagList(icon("clock"), " Saat/H…ôft…ô *"),
                              value = 4,
                              min = 1,
                              max = 10,
                              width = "100%")
          ),
          column(4,
                 numericInput(ns("weeks_per_year"),
                              label = tagList(icon("calendar"), " H…ôft…ô/ƒ∞l *"),
                              value = 36,
                              min = 1,
                              max = 52,
                              width = "100%")
          ),
          column(4,
                 textInput(ns("academic_year"),
                           label = tagList(icon("calendar-alt"), " T…ôdris ili"),
                           value = "2024-2025",
                           width = "100%")
          )
        ),
        
        hr(),
        
        selectInput(ns("reference_countries"),
                    label = tagList(icon("globe"), " Referans √ñlk…ôl…ôr"),
                    choices = setNames(COUNTRIES$code, COUNTRIES$name_az),
                    selected = c("AZ", "FI", "SG"),
                    multiple = TRUE,
                    width = "100%"),
        
        textAreaInput(ns("special_focus"),
                      label = tagList(icon("bullseye"), " X√ºsusi Fokus (optional)"),
                      placeholder = "M…ôs…ôl…ôn: STEM, kritik t…ôf…ôkk√ºr, layih…ô …ôsaslƒ± √∂yr…ônm…ô...",
                      rows = 3,
                      width = "100%"),
        
        hr(),
        
        actionButton(ns("btn_generate"),
                     label = tagList(icon("magic"), " Kurikulum Yarat"),
                     class = "btn btn-success btn-lg",
                     style = "width: 100%; padding: 15px; font-size: 1.2em;")
      ),
      
      # Info Panel
      box(
        title = tagList(icon("info-circle"), " M…ôlumat"),
        status = "info",
        solidHeader = TRUE,
        width = 4,
        
        h4("ü§ñ AI Prosess:"),
        tags$ol(
          tags$li("Claude Sonnet 4.5"),
          tags$li("GPT-4o (optional)"),
          tags$li("M√ºqayis…ô rejimi")
        ),
        
        hr(),
        
        uiOutput(ns("info_totals"))
      )
    ),
    
    # Progress
    uiOutput(ns("progress_section")),
    
    # Results
    uiOutput(ns("results_section"))
  )
}

# SERVER
curriculum_generator_server <- function(id) {
  moduleServer(id, function(input, output, session) {
    
    ns <- session$ns
    
    # Reactive values
    rv <- reactiveValues(
      generating = FALSE,
      curriculum = NULL,
      generation_info = NULL
    )
    
    # Calculate totals
    output$info_totals <- renderUI({
      hours <- input$hours_per_week
      weeks <- input$weeks_per_year
      
      if (is.null(hours) || is.null(weeks)) {
        return(div(
          style = "background: #f3e5f5; padding: 15px; border-radius: 10px;",
          h4(style = "margin-top: 0; color: #7b1fa2;", "üìä Hesablamalar:"),
          p("Y√ºkl…ônir...")
        ))
      }
      
      total_hours <- hours * weeks
      
      div(
        style = "background: #f3e5f5; padding: 15px; border-radius: 10px;",
        h4(style = "margin-top: 0; color: #7b1fa2;", "üìä Hesablamalar:"),
        p(tags$b("√úmumi saat:"), " ", total_hours, " saat"),
        p(tags$b("T…ôxmini m√ºdd…ôt:"), " ", weeks, " h…ôft…ô")
      )
    })
    
    # Generate button
    observeEvent(input$btn_generate, {
      
      # Validation
      if (is.null(input$subject) || input$subject == "") {
        showNotification("‚ö†Ô∏è F…ônn se√ßilm…ôlidir!", type = "error", duration = 3)
        return()
      }
      
      if (is.null(input$grade) || input$grade == "") {
        showNotification("‚ö†Ô∏è Sinif se√ßilm…ôlidir!", type = "error", duration = 3)
        return()
      }
      
      # Start generation
      rv$generating <- TRUE
      rv$curriculum <- NULL
      rv$generation_info <- NULL
      
      tryCatch({
        
        result <- generate_curriculum_dual_ai(
          subject = input$subject,
          grade = as.integer(input$grade),
          hours_per_week = input$hours_per_week,
          weeks_per_year = input$weeks_per_year,
          reference_countries = input$reference_countries,
          special_focus = input$special_focus
        )
        
        if (result$success) {
          
          rv$curriculum <- result$curriculum
          rv$generation_info <- result
          
          # Save to database
          curriculum_data <- list(
            name = paste(input$subject, input$grade, "sinif kurikulumu"),
            subject_id = SUBJECTS[SUBJECTS$name_az == input$subject, "id"][1],
            subject_name = input$subject,
            grade = as.integer(input$grade),
            academic_year = input$academic_year,
            hours_per_week = input$hours_per_week,
            weeks_per_year = input$weeks_per_year,
            total_hours = input$hours_per_week * input$weeks_per_year,
            description = substr(result$curriculum, 1, 500),
            philosophy = NA,
            learning_outcomes = NA,
            content_structure = result$curriculum,
            methodology = NA,
            assessment = NA,
            resources = NA,
            azerbaijan_standards = "Az…ôrbaycan T…ôhsil Standartlarƒ±",
            international_standards = paste(input$reference_countries, collapse = ","),
            reference_countries = paste(input$reference_countries, collapse = ","),
            generated_by = "AI",
            ai_model = result$method,
            creation_method = result$method,
            status = "draft",
            created_by = "system"
          )
          
          curriculum_id <- save_curriculum(curriculum_data)
          
          log_ai_generation(
            curriculum_id = curriculum_id,
            ai_model = result$method,
            prompt = "Dual AI generation",
            response = result$curriculum,
            tokens_used = result$claude_tokens + result$gpt_tokens + result$synthesis_tokens,
            duration = result$total_duration,
            status = "success"
          )
          
          showNotification("‚úÖ Kurikulum uƒüurla yaradƒ±ldƒ±!", type = "message", duration = 5)
          
        } else {
          showNotification(paste("‚ùå X…ôta:", result$error), type = "error", duration = 10)
        }
        
        rv$generating <- FALSE
        
      }, error = function(e) {
        rv$generating <- FALSE
        showNotification(paste("‚ùå X…ôta:", as.character(e)), type = "error", duration = 10)
      })
    })
    
    # Progress section
    output$progress_section <- renderUI({
      if (!rv$generating) return(NULL)
      
      box(
        title = tagList(icon("spinner", class = "fa-spin"), " Yaradƒ±lƒ±r..."),
        status = "warning",
        solidHeader = TRUE,
        width = 12,
        
        div(style = "padding: 20px; text-align: center;",
            h4("ü§ñ AI kurrikulumu hazƒ±rlayƒ±r..."),
            p("Bu proses 30-60 saniy…ô √ß…ôk…ô bil…ôr."))
      )
    })
    
    # Results section
    output$results_section <- renderUI({
      req(rv$curriculum, rv$generation_info)
      
      info <- isolate(rv$generation_info)
      
      # Main results
      result_ui <- tagList(
        # Info box
        box(
          title = tagList(icon("check-circle"), " Yaradƒ±lma M…ôlumatƒ±"),
          status = "success",
          solidHeader = TRUE,
          width = 12,
          collapsible = TRUE,
          
          fluidRow(
            column(3,
                   div(style = "text-align: center; padding: 20px; background: #e8f5e9; border-radius: 10px;",
                       h3(style = "margin: 0; color: #2e7d32;", info$method),
                       p("Metod")
                   )
            ),
            column(3,
                   div(style = "text-align: center; padding: 20px; background: #e3f2fd; border-radius: 10px;",
                       h3(style = "margin: 0; color: #1565c0;", 
                          info$claude_tokens + info$gpt_tokens + info$synthesis_tokens),
                       p("Token")
                   )
            ),
            column(3,
                   div(style = "text-align: center; padding: 20px; background: #fff3e0; border-radius: 10px;",
                       h3(style = "margin: 0; color: #ef6c00;", 
                          round(info$total_duration, 1), " san"),
                       p("M√ºdd…ôt")
                   )
            ),
            column(3,
                   actionButton(ns("btn_export_html"),
                                label = tagList(icon("file-code"), " HTML Export"),
                                class = "btn btn-success btn-lg",
                                style = "width: 100%; margin-top: 10px; font-weight: bold;")
            )
          )
        ),
        
        # Content box
        box(
          title = tagList(icon("file-text"), " Kurikulum M…ôzmunu"),
          status = "primary",
          solidHeader = TRUE,
          width = 12,
          collapsible = TRUE,
          collapsed = FALSE,
          
          div(style = "max-height: 600px; overflow-y: auto; padding: 20px; background: white; border-radius: 10px;",
              pre(style = "white-space: pre-wrap; font-family: 'Segoe UI'; line-height: 1.8;",
                  isolate(rv$curriculum)))
        )
      )
      
      # Add comparison box if both AI worked
      if (!is.null(info$comparison_available) && info$comparison_available == TRUE) {
        
        comparison_ui <- box(
          title = tagList(icon("balance-scale"), " AI M√ºqayis…ôsi - Claude vs GPT"),
          status = "warning",
          solidHeader = TRUE,
          width = 12,
          collapsible = TRUE,
          collapsed = TRUE,
          
          # Comparison Export Button
          div(style = "text-align: right; margin-bottom: 15px;",
              actionButton(ns("btn_export_comparison"),
                           label = tagList(icon("download"), " M√ºqayis…ô HTML Export"),
                           class = "btn btn-warning btn-lg",
                           style = "font-weight: bold;")
          ),
          
          hr(),
          
          fluidRow(
            column(6,
                   div(style = "background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; text-align: center; margin-bottom: 15px;",
                       h4(style = "margin: 0;", icon("robot"), " Claude Sonnet 4.5"),
                       p(style = "margin: 5px 0 0 0;", info$claude_tokens, " tokens")
                   ),
                   div(style = "max-height: 500px; overflow-y: auto; padding: 15px; background: #f8f9fa; border: 3px solid #667eea; border-radius: 10px;",
                       pre(style = "white-space: pre-wrap; font-size: 0.9em;",
                           info$claude_curriculum))
            ),
            column(6,
                   div(style = "background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 15px; border-radius: 10px; text-align: center; margin-bottom: 15px;",
                       h4(style = "margin: 0;", icon("robot"), " GPT-4o"),
                       p(style = "margin: 5px 0 0 0;", info$gpt_tokens, " tokens")
                   ),
                   div(style = "max-height: 500px; overflow-y: auto; padding: 15px; background: #f8f9fa; border: 3px solid #10b981; border-radius: 10px;",
                       pre(style = "white-space: pre-wrap; font-size: 0.9em;",
                           info$gpt_curriculum))
            )
          )
        )
        
        result_ui <- tagList(result_ui, comparison_ui)
      }
      
      return(result_ui)
    })
    
    # Export HTML - Claude curriculum
    observeEvent(input$btn_export_html, {
      
      req(rv$curriculum, rv$generation_info)
      
      subject_val <- isolate(input$subject)
      grade_val <- isolate(input$grade)
      hours_val <- isolate(input$hours_per_week)
      weeks_val <- isolate(input$weeks_per_year)
      year_val <- isolate(input$academic_year)
      countries_val <- isolate(input$reference_countries)
      info <- isolate(rv$generation_info)
      
      withProgress(message = 'HTML yaradƒ±lƒ±r...', value = 0.5, {
        
        tryCatch({
          
          curriculum_data <- list(
            name = paste(subject_val, grade_val, "sinif kurikulumu"),
            subject_name = subject_val,
            grade = grade_val,
            hours_per_week = hours_val,
            weeks_per_year = weeks_val,
            total_hours = hours_val * weeks_val,
            academic_year = year_val,
            reference_countries = paste(
              COUNTRIES[COUNTRIES$code %in% countries_val, "name_az"],
              collapse = ", "
            )
          )
          
          result <- export_curriculum_html(
            curriculum_data = curriculum_data,
            curriculum_content = isolate(rv$curriculum),
            generation_info = info
          )
          
          if (result$success) {
            showNotification(
              HTML(paste0(
                "<strong>‚úÖ HTML yaradƒ±ldƒ±!</strong><br>",
                "Fayl: ", result$filename, "<br>",
                "√ñl√ß√º: ", round(result$size / 1024, 1), " KB"
              )),
              type = "message",
              duration = 10
            )
            
            Sys.sleep(0.5)
            browseURL(result$path)
            
          } else {
            showNotification(
              paste0("‚ùå X…ôta: ", result$error),
              type = "error",
              duration = 10
            )
          }
          
        }, error = function(e) {
          showNotification(
            paste0("‚ùå Export x…ôtasƒ±: ", as.character(e)),
            type = "error",
            duration = 10
          )
        })
      })
    })
    
    # Export Comparison HTML - Claude vs GPT
    observeEvent(input$btn_export_comparison, {
      
      req(rv$generation_info)
      
      info <- isolate(rv$generation_info)
      
      # Check if comparison available
      if (is.null(info$comparison_available) || !info$comparison_available) {
        showNotification("‚ö†Ô∏è M√ºqayis…ô m√∂vcud deyil!", type = "warning", duration = 3)
        return()
      }
      
      subject_val <- isolate(input$subject)
      grade_val <- isolate(input$grade)
      hours_val <- isolate(input$hours_per_week)
      weeks_val <- isolate(input$weeks_per_year)
      year_val <- isolate(input$academic_year)
      countries_val <- isolate(input$reference_countries)
      
      withProgress(message = 'M√ºqayis…ô HTML yaradƒ±lƒ±r...', value = 0.5, {
        
        tryCatch({
          
          curriculum_data <- list(
            name = paste(subject_val, grade_val, "sinif kurikulumu"),
            subject_name = subject_val,
            grade = grade_val,
            hours_per_week = hours_val,
            weeks_per_year = weeks_val,
            total_hours = hours_val * weeks_val,
            academic_year = year_val,
            reference_countries = paste(
              COUNTRIES[COUNTRIES$code %in% countries_val, "name_az"],
              collapse = ", "
            )
          )
          
          result <- export_comparison_html(
            curriculum_data = curriculum_data,
            claude_content = info$claude_curriculum,
            gpt_content = info$gpt_curriculum,
            claude_tokens = info$claude_tokens,
            gpt_tokens = info$gpt_tokens,
            claude_duration = info$total_duration / 2,
            gpt_duration = info$total_duration / 2
          )
          
          if (result$success) {
            showNotification(
              HTML(paste0(
                "<strong>‚úÖ M√ºqayis…ô HTML yaradƒ±ldƒ±!</strong><br>",
                "Fayl: ", result$filename, "<br>",
                "√ñl√ß√º: ", round(result$size / 1024, 1), " KB"
              )),
              type = "message",
              duration = 10
            )
            
            Sys.sleep(0.5)
            browseURL(result$path)
            
          } else {
            showNotification(
              paste0("‚ùå X…ôta: ", result$error),
              type = "error",
              duration = 10
            )
          }
          
        }, error = function(e) {
          showNotification(
            paste0("‚ùå Export x…ôtasƒ±: ", as.character(e)),
            type = "error",
            duration = 10
          )
        })
      })
    })
    
  })
}
